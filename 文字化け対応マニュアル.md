# PowerShellスクリプトの文字化け対応マニュアル

## 文字化けの原因

PowerShellスクリプトで文字化けが発生する主な原因は以下の通りです：

1. **文字コードの不一致**：
   - ファイルが保存された文字コードとPowerShellが読み込む際の文字コードが異なる場合
   - 主にShift-JISとUTF-8の間の変換で発生

2. **BOMの有無**：
   - UTF-8でもBOM(Byte Order Mark)の有無によって動作が異なる
   - PowerShellはBOM付きUTF-8を推奨

3. **コンソール出力の設定**：
   - PowerShellコンソールの出力エンコーディングが不適切な場合

## 対応方法

### 1. 文字化け修正ツールを使用する（推奨）

当ツールセットに含まれる文字化け診断・修正ツールを使用してください：

1. `文字化け修正.bat` をダブルクリック
2. 「参照...」ボタンをクリックして文字化けしているスクリプトを選択
3. 「ファイル分析」ボタンをクリックして現在の文字コードを確認
4. 変換後の文字コードとして「utf-8」を選択し、BOMにチェックを入れる
5. 「変換実行」ボタンをクリックして変換を実行

### 2. コマンドラインで修正する

コマンドラインから直接修正する場合は以下のコマンドを使用します：

```powershell
.\CharacterEncodingTool.ps1 -InputFile "変換したいファイル.ps1" -SourceEncoding "shift-jis" -TargetEncoding "utf-8" -BOM $true
```

パラメーター：
- `-InputFile`：変換するファイルパス
- `-SourceEncoding`：元の文字コード（auto, utf-8, utf-16, shift-jis, euc-jp, ascii）
- `-TargetEncoding`：変換後の文字コード（utf-8, utf-16, shift-jis, euc-jp, ascii）
- `-BOM`：BOMの有無（$true または $false）

### 3. コンソール出力の文字化け対策

PowerShellコンソール自体の出力が文字化けする場合：

```powershell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

このコマンドをスクリプトの先頭に追加するか、セッション開始時に実行してください。

## 文字コードの確認方法

### VSCode での確認方法
1. ファイルを開く
2. 右下のステータスバーに表示される「UTF-8」や「Shift JIS」などの表示を確認
3. クリックすると変更可能

### その他のエディタでの確認方法
- **メモ帳**：「名前を付けて保存」ダイアログで「エンコード」を確認
- **サクラエディタ**：ステータスバーに表示される文字コードを確認

## 推奨設定

### PowerShellスクリプトの推奨文字コード
- **BOM付きUTF-8** が最も推奨される形式です
- これによりUnicodeの全文字を正しく扱え、PowerShellからも適切に認識されます

### VSCodeの設定
1. ファイル > 基本設定 > 設定
2. 「Files: Encoding」を検索
3. 「utf8bom」に設定

### 新規スクリプト作成時の文字コード設定
新規スクリプトを作成する際は、必ず「BOM付きUTF-8」で保存してください。

## トラブルシューティング

| 症状 | 原因 | 解決策 |
|------|------|--------|
| 日本語が文字化けする | 文字コードの不一致 | BOM付きUTF-8に変換 |
| 特殊記号が表示されない | Unicodeの扱いに問題 | BOM付きUTF-8に変換 |
| 読み込み時にエラーが発生 | BOMの問題 | 文字化け修正ツールで修正 |
| コンソール出力だけ文字化け | コンソールの設定問題 | `[Console]::OutputEncoding` を設定 |

## 詳細情報

### 主な文字コードの特徴

| 文字コード | 特徴 | 日本語対応 | BOM |
|------------|------|------------|-----|
| UTF-8      | 可変長。国際標準 | ◯ | オプション |
| UTF-16     | 2バイト固定。Windowsで一般的 | ◯ | あり |
| Shift-JIS  | 日本語用。古いシステムとの互換性 | ◯ | なし |
| EUC-JP     | UNIXシステムでの日本語用 | ◯ | なし |
| ASCII      | 英数字のみ | × | なし |

### BOMとは
BOM(Byte Order Mark)はファイルの先頭に付与される特殊なマーカーで、そのファイルがUnicode(UTF-8/16/32)であることを示します。PowerShellはBOM付きUTF-8ファイルを正しく認識できますが、BOMなしUTF-8ファイルをShift-JISと誤認する場合があります。
