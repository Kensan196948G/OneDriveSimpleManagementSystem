# 📚 OneDrive運用ツール

## 🌟 概要
このツールセットはMicrosoft 365環境におけるOneDriveの使用状況をモニタリングし、レポートを生成するためのPowerShellツールです。
管理者はこのツールを使用して組織全体のOneDrive使用状況を把握し、容量管理や監査に活用できます。

## 📁 ファイル構成
- 📊 `OneDriveStatusCheck.ps1` - メインのOneDrive状態確認スクリプト
- 🔍 `診断/OneDriveDebugLog.ps1` - OneDrive接続診断用スクリプト
- 🛠️ `修正ツール/CharacterEncodingFixer.ps1` - スクリプトの文字エンコーディング修正ツール
- 🔧 `修正ツール/文字化け修正.bat` - エンコーディング修正ツールの起動バッチ
- 📋 `logs/` - ログファイル保存フォルダ

## 📝 使用方法

### ✅ 事前準備
1. PowerShell 5.1以上が必要です
2. 以下のModuleが必要です:
   - 🔑 Microsoft.Graph.Authentication
   - 👤 Microsoft.Graph.Users
   - 📂 Microsoft.Graph.Files

> 💡 必要なモジュールがインストールされていない場合は、スクリプト実行時に自動的にインストールするオプションが表示されます。

### 🔤 文字化け問題が発生する場合
スクリプトファイルの文字エンコーディングに問題がある場合は、以下の手順で修正してください：

1. 🔧 `修正ツール/文字化け修正.bat` をダブルクリックして文字エンコーディング修正ツールを起動
2. 📂 フォルダとファイルパターンを設定（デフォルトでは現在のフォルダの *.ps1）
3. 🔍 「ファイルをスキャン」をクリックして対象ファイルを検出
4. 🔄 「エンコーディング変換」をクリックしてUTF-8形式に変換

### 🔍 OneDrive接続診断の実行
接続に問題がある場合は、まず診断スクリプトを実行してください。

```powershell
.\診断\OneDriveDebugLog.ps1
```

このスクリプトは以下の項目をチェックします：
- ✅ Microsoft Graphモジュールの存在を確認
- 🔌 Graph APIへの接続をテスト
- 🔐 OneDriveへのアクセスを検証
- 👑 管理者権限の有無を確認
- 📝 詳細なログを `logs` フォルダに出力

### 📊 OneDriveステータスレポート作成
メインのスクリプトを実行してOneDriveのレポートを生成します。

```powershell
.\OneDriveStatusCheck.ps1
```

#### 📈 レポート機能
生成されるレポートには以下の機能があります：

- 🔍 **データ検索機能**: テーブル上部の検索ボックスで全項目から検索できます
- 📤 **エクスポート機能**: Excel、CSV、PDF形式でデータをエクスポートできます
- 🖨️ **印刷機能**: テーブルデータを印刷できます
- 👁️ **表示列の選択**: 表示する列を選択できます

#### 📋 レポートに含まれる情報
- 👤 ユーザー情報（氏名、アカウント名、メールアドレス）
- 🚦 OneDriveの状態
- 💾 割当容量と使用容量
- 📊 使用率
- 🕒 最終更新日時

## ⚠️ トラブルシューティング

### 🚫 エラー: アクセス権限が不足している
管理者権限がない場合、自分自身のOneDrive情報のみ取得可能です。以下の権限が必要です：
- 👥 User.Read.All
- 📂 Files.Read.All

### 🔌 エラー: Microsoft Graph APIへの接続に失敗
1. 🌐 インターネット接続を確認してください
2. 🔑 Microsoft 365アカウント認証情報が正しいか確認してください
3. 🔍 OneDriveDebugLogスクリプトを実行して詳細な診断情報を取得してください

### 🔤 エラー: 文字化けが発生する
PowerShellの文字エンコーディングの問題が考えられます。「文字化け修正.bat」ツールを使用してスクリプトファイルの文字エンコーディングを修正してください。

### 🔒 アクセス拒否エラー対応手順

OneDriveステータス取得中に「Access denied」エラーが発生した場合の対応手順です。

#### 1️⃣ 認証キャッシュのクリア

以下のコマンドを実行して、Microsoft Graphの認証キャッシュをクリアします：

```powershell
Disconnect-MgGraph
```

#### 2️⃣ アプリケーション権限の確認

OneDriveステータスを取得するには以下の権限が必要です：
- 👥 User.Read.All
- 📂 Files.Read.All
- 📚 Directory.Read.All
- 🌐 Sites.Read.All

#### 3️⃣ スクリプト実行時のパラメータ設定

エラーが発生するユーザーをスキップして処理を継続するには、以下のパラメータを使用します：

```powershell
.\OneDriveStatusCheck.ps1 -SkipErrorUsers $true
```

#### 4️⃣ 管理者権限での実行

スクリプトは必ず管理者権限を持つアカウントで実行してください。

#### 5️⃣ エラーが続く場合

特定のユーザーでエラーが続く場合、以下の確認を行ってください：

1. 🆕 ユーザーがOneDriveを一度も使用していない可能性
2. 🔒 ユーザーのOneDriveに特別なアクセス制限が設定されている可能性
3. 👑 管理者アカウントに特定のSharePoint管理者権限が付与されていない可能性

## 📅 更新履歴
- 📆 2025/03/15 - 文字エンコーディング修正ツール追加、レポート機能強化
- 📆 2025/03/10 - 診断スクリプト追加
- 📆 2025/03/05 - 初期バージョン

## ℹ️ 注意事項
- ⏱️ 大規模環境では実行に時間がかかる場合があります
- 📁 デフォルトでは出力フォルダは `C:\kitting\OneDrive運用ツール\OneDriveStatus.(日付)` に作成されます
- 👑 管理者権限の確認にはAzure ADのロール情報を使用します