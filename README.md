# 📊 OneDrive運用ツール マニュアル

## 🌟 概要
このツールは組織内のOneDriveの使用状況を確認するためのツールです。
全ユーザーのOneDriveのステータス、使用容量、最終更新日時などを取得し、レポートを作成します。

## ⚙️ 動作要件
- 🖥️ Windows 10/11
- 🔷 PowerShell 5.1以上
- 🌐 インターネット接続
- 👤 Microsoft 365アカウント（管理者権限があれば全ユーザー情報、一般ユーザーでは自分のみ）

## 🚀 インストール方法
1. このフォルダを`C:\kitting\OneDrive運用ツール`に配置してください
2. 初回実行時に必要なモジュールは自動的にインストールされます

## 📝 使用方法

### OneDriveステータス確認ツールの起動
1. `RunOneDriveStatusCheck.bat`をダブルクリックします
2. 🔒 認証方法を選択します:
   - 🟢 **通常の認証（推奨）**: Microsoft 365アカウントでサインイン
   - 🔵 **デバイスコード認証**: 別デバイスで認証コードを使用してサインイン

3. Microsoft 365アカウントでサインインします
4. 実行完了後、自動的にHTMLレポートが開きます

### 📁 出力ファイル
実行すると以下のファイルが生成されます:
- 📰 **HTMLレポート**: データテーブル形式でのレポート（フィルタリングや検索が可能）
- 📊 **CSVファイル**: Excelなどで開ける形式のデータ
- 📝 **ログファイル**: 実行ログ（トラブルシューティング用）

### 出力フォルダ
すべての出力ファイルは日付ベースのフォルダ内に保存されます:
```
C:\kitting\OneDrive運用ツール\OneDriveStatus.YYYYMMDD\
```

## ❓ トラブルシューティング

### JavaScriptのエラーが発生する場合
スクリプト実行中に「document is not recognized as the name of a cmdlet」などのエラーが表示された場合:

1. `FixJavaScript.ps1` ユーティリティを使用して問題を修正できます
   ```powershell
   .\FixJavaScript.ps1 -JsFilePath "問題のJSファイルパス"
   ```

### 🔒 アクセス権限の問題
- 「アクセスが拒否されました」などのエラーが表示される場合:
  1. Azure ADポータルで権限を確認してください
  2. Microsoft Graph Command Line Toolsアプリに以下の権限が付与されていることを確認:
     - 📖 User.Read.All
     - 📂 Files.Read.All

### OneDrive情報が取得できない問題
- 認証は成功するものの、OneDrive情報が「取得不可」と表示される場合:
  1. ログファイルでエラーメッセージを確認
  2. アクセストークンが正しく取得できているか確認
  3. 必要に応じて、Microsoft Graph APIの最新状態を確認

## 📋 ファイル一覧
| ファイル名 | 説明 |
|------------|------|
| 📜 OneDriveStatusCheck.ps1 | OneDrive情報取得・レポート生成のメインスクリプト |
| 📜 RunOneDriveStatusCheck.bat | 実行用バッチファイル |
| 📜 FixJavaScript.ps1 | JavaScriptファイル修正ユーティリティ |
| 📄 README.md | このマニュアル |

## 📌 実行手順の詳細

1. **初期化**
   - エンコーディング設定
   - ログファイルの初期化
   - 出力フォルダの作成

2. **モジュール準備**
   - Microsoft Graph モジュールのインストール
   - 権限の確認

3. **Microsoft Graph 認証**
   - 選択した認証方法でサインイン
   - アプリケーション権限の検証

4. **OneDrive情報収集**
   - ユーザー一覧の取得（管理者の場合）
   - 各ユーザーのOneDriveステータス取得
   - 容量情報の計算

5. **レポート生成**
   - CSV出力
   - JavaScript生成
   - HTML出力
   - 自動的にレポートを開く

## 🔧 よくある問題と解決策

### Q: 認証は成功するが、OneDriveの情報が取得できない
A: 以下を確認してください:
- Microsoft Graph APIへの権限が正しく設定されているか
- ユーザーアカウントがOneDriveを有効化しているか
- ログファイルでどのAPIコールが失敗しているか確認

### Q: 「アプリケーションのアクセス許可」エラーが出る
A: Azure ADポータルで、「Microsoft Graph Command Line Tools」アプリに必要な権限が付与され、管理者の同意が行われているか確認してください。

### Q: スクリプトの実行が長時間かかる
A: 多数のユーザーがいる環境では、OneDrive情報の取得に時間がかかります。Microsoft Graph APIのレート制限に配慮してください。

---

© 2025 OneDrive運用管理ツール

# OneDrive運用ツール - 使用方法

## 概要
このツールはユーザーのOneDriveの使用状況を確認し、レポートを生成するために開発されました。
HTML、CSV、JavaScript形式で出力することができます。

## 必要権限
このツールを使用するには、以下の権限が必要です：

### 一般ユーザーモード（自分のOneDriveのみ確認）
- User.Read
- Files.Read

### 管理者モード（全ユーザーのOneDriveを確認）
- User.Read.All
- Files.Read.All

## よくあるエラーとその対処方法

### 「有効なアクセストークンがありません。」
**原因**: アクセス権限が不足しているか、認証に失敗しています。

**対処方法**:
1. 一般ユーザーとして使用している場合は、自分のOneDriveの情報のみ取得できます
2. 管理者として全ユーザーの情報を取得する場合は、グローバル管理者または適切な権限を持つアカウントでログインしてください
3. アプリケーションのアクセス許可が正しく設定されているか確認してください（スクリプト実行時に表示される手順を参照）

### 「Unauthorized」または「権限がありません」
**原因**: APIを呼び出すために必要な権限がアカウントに付与されていません。

**対処方法**:
1. Azure ADポータルでアプリの登録を確認し、必要な権限（User.Read.All, Files.Read.All）が付与されているか確認してください
2. 管理者の同意が必要な場合は、グローバル管理者に依頼してください

### 「Microsoft Graph APIに接続されていません」
**原因**: 認証セッションが確立できていないか、期限切れです。

**対処方法**:
1. 再度ログインしてください
2. インターネット接続を確認してください
3. 組織のプロキシ設定などがある場合は、必要なURLが許可されているか確認してください

## ログファイル
エラーが発生した場合は、出力フォルダ内のログファイルを確認してください。
問題解決に役立つ詳細情報が含まれています。

## サポート
ツールの使用に関して問題がある場合は、IT管理者にお問い合わせください。