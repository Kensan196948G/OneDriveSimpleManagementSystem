# OneDrive運用ツール マニュアル

## 1. 概要
OneDrive運用ツールは、Microsoft 365環境でのOneDrive使用状況をモニタリングし、詳細なレポートを生成するためのツールセットです。
管理者権限を持つユーザーは組織全体のOneDrive状況を確認でき、一般ユーザーは自分のOneDrive情報を確認できます。

## 2. インストール方法

### 2.1 必要環境
- Windows 10/11
- PowerShell 5.1以上
- Microsoft 365アカウント（管理者権限推奨）
- インターネット接続

### 2.2 インストール手順
1. ツールフォルダをC:\kittingなど任意の場所に配置
2. 管理者権限でPowerShellを起動し、実行ポリシーを確認
   ```powershell
   Get-ExecutionPolicy
   ```
3. 必要に応じて実行ポリシーを変更
   ```powershell
   Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
   ```

### 2.3 必要モジュールの確認
以下の管理者権限を持つPowerShellコマンドで必要なモジュールをインストール
```powershell
Install-Module Microsoft.Graph.Authentication -Scope CurrentUser -Force
Install-Module Microsoft.Graph.Users -Scope CurrentUser -Force
Install-Module Microsoft.Graph.Files -Scope CurrentUser -Force
```

## 3. ツールの使用方法

### 3.1 OneDriveReportShortcut.bat（メインメニュー）
「OneDriveReportShortcut.bat」をダブルクリックして起動すると以下のメニューが表示されます：

1. **OneDriveステータスレポート作成** - メインのレポート生成機能
2. **OneDrive接続診断ツール実行** - Graph APIとの接続テスト
3. **文字化け修正ツール起動** - 文字エンコーディング問題の修正
0. **終了** - プログラムを終了

### 3.2 OneDriveStatusCheck.ps1（レポート生成）
このスクリプトは組織内のOneDrive使用状況レポートを生成します。

#### 手順
1. メニューから「OneDriveステータスレポート作成」を選択
2. Microsoft 365アカウントでサインイン
3. 権限の同意画面が表示されたら「同意する」をクリック
4. レポート生成が完了すると自動的にブラウザでHTMLレポートが表示

#### 生成されるレポートの種類
- HTML形式 - インタラクティブな表示・検索・エクスポート機能付き
- CSV形式 - 表計算ソフトでの分析用
- ログファイル - トラブルシューティング用

#### レポートの保存先
```
C:\kitting\OneDrive運用ツール\OneDriveStatus.YYYYMMDD\OneDriveStatus_YYYYMMDDHHMMSS.*
```

### 3.3 OneDriveDebugLog.ps1（接続診断）
このスクリプトはOneDriveとの接続問題を診断します。

#### 手順
1. メニューから「OneDrive接続診断ツール実行」を選択
2. Microsoft 365アカウントでサインイン
3. 診断が実行され、接続状態が確認されます
4. 結果は画面とログファイルに出力されます

#### 確認項目
- Microsoft Graphモジュールの存在
- Graph APIへの接続状態
- OneDriveへのアクセス権限
- 管理者権限の確認

#### ログの保存先
```
C:\kitting\OneDrive運用ツール\logs\OneDriveDebug_YYYYMMDD_HHMMSS.log
```

### 3.4 文字化け修正ツール
スクリプトファイルの文字エンコーディングに問題がある場合に使用します。

#### 手順
1. メニューから「文字化け修正ツール起動」を選択
2. 対象フォルダとファイルパターンを設定
3. 「ファイルをスキャン」をクリックして対象ファイルを表示
4. 「エンコーディング変換」をクリックしてUTF-8形式に変換

## 4. レポートの活用方法

### 4.1 HTMLレポートの機能
HTMLレポートには以下の機能があります：

#### 4.1.1 データ検索機能
- **クイック検索:** 画面上部の検索ボックスに検索語を入力するだけで、表示されているすべての列から該当するデータを絞り込みます
- **列固有の検索:** 各列のヘッダーをクリックして昇順/降順ソートや、列固有の検索条件を設定できます
- **複合検索:** 複数の条件を組み合わせた高度な検索が可能です

#### 4.1.2 データエクスポート機能
レポート画面上部のボタンから以下の形式でデータをエクスポートできます：
- **コピー:** クリップボードにデータをコピー
- **CSV:** カンマ区切りテキストとして保存
- **Excel:** Microsoft Excel形式で保存（xlsx）
- **PDF:** PDF形式で保存
- **印刷:** 現在の表示内容を印刷

#### 4.1.3 表示カスタマイズ機能
- **表示列の選択:** 「表示列」ボタンから必要な列のみを表示
- **ページサイズの変更:** 一度に表示するレコード数を変更
- **全データ表示:** ページ分割なしですべてのデータを表示

### 4.2 データ分析のポイント
以下のようなデータ分析を行うことができます：

1. **使用率の高いユーザーの特定**
   - 使用率列で降順ソートし、容量を多く使用しているユーザーを特定

2. **長期間更新されていないアカウントの特定**
   - 最終更新日時で昇順ソートし、利用されていないOneDriveを特定

3. **部門別の集計（CSVエクスポート後）**
   - CSVをExcelにインポートし、部門ごとのピボットテーブルを作成

4. **容量不足の予測**
   - 使用率が70%を超えるアカウントを抽出し、容量増加が必要なユーザーを予測

## 5. トラブルシューティング

### 5.1 認証エラー
**症状:** Microsoft 365アカウントでサインインできない、または権限不足エラーが表示される

**解決策:**
1. アカウントのパスワードが正しいことを確認
2. インターネット接続を確認
3. 多要素認証が有効な場合は、認証アプリでの承認を完了
4. OneDriveDebugLog.ps1を実行して詳細なエラー情報を取得

### 5.2 モジュールエラー
**症状:** Microsoft.Graphモジュールがないというエラーが表示される

**解決策:**
1. 管理者権限でPowerShellを開き、以下のコマンドを実行
   ```powershell
   Install-Module Microsoft.Graph -Scope CurrentUser -Force
   ```
2. インストール後、スクリプトを再実行

### 5.3 文字化けの問題
**症状:** スクリプト実行時に文字が正しく表示されない

**解決策:**
1. 「文字化け修正.bat」を実行
2. 対象フォルダを選択し「ファイルをスキャン」をクリック
3. すべてのスクリプトファイルを選択し「エンコーディング変換」をクリック
4. UTF-8形式に変換後、再度スクリプトを実行

### 5.4 レポート生成エラー
**症状:** レポート生成が途中で停止するか、またはエラーで終了する

**解決策:**
1. ログファイルを確認（C:\kitting\OneDrive運用ツール\OneDriveStatus.YYYYMMDD\*.log）
2. OneDrive接続診断ツールを実行して権限を確認
3. 一時フォルダのアクセス権があることを確認
4. PowerShellの実行ポリシーを確認し、必要に応じて変更

## 6. 運用のベストプラクティス

### 6.1 定期的な実行スケジュール
容量の監視と管理を効率的に行うため、以下のスケジュールでの実行を推奨します：
- 週次: 基本的なOneDrive使用状況モニタリング
- 月次: 詳細なレポート生成と分析
- 四半期: 長期間使用されていないアカウントの特定と整理

### 6.2 レポートの保管
効率的なレポート管理とトレンド分析のため：
- 月次レポートは最低12ヶ月分保存
- 重要なレポートは別の場所にバックアップ
- リポートの命名規則を統一（例：OneDriveStatus_YYYYMM_部門名）

### 6.3 アクセス権管理
ツールとレポートのセキュリティを確保するため：
- 管理者アカウントの資格情報を安全に管理
- レポートへのアクセスは関連部門のみに制限
- ユーザー個人データを含むレポートは適切なデータ保護ポリシーに従って管理

## 7. FAQ

**Q: 一般ユーザーでもツールを使用できますか？**
A: はい、一般ユーザーも自分自身のOneDrive情報を取得できます。ただし、他ユーザーのデータにはアクセスできません。

**Q: 出力されたHTMLファイルはオフラインでも閲覧できますか？**
A: はい、生成されたHTMLファイルには必要なデータがすべて埋め込まれており、オフラインでも閲覧可能です。

**Q: 大規模環境（数千ユーザー）での実行時間はどれくらいですか？**
A: 数千ユーザー規模の環境では30分～1時間程度かかる場合があります。ネットワーク環境によっても異なります。

**Q: レポートの結果をSharePointに直接保存できますか？**
A: 現在のバージョンでは直接SharePointに保存する機能はありません。レポート生成後に手動でアップロードしてください。

**Q: データの正確性はどの程度ですか？**
A: Microsoft Graph APIから直接データを取得するため、Microsoft 365管理センターで表示される情報と同等の正確性があります。